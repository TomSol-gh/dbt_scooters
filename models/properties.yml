version: 2

sources:
  - name: "scooters_raw"
    description: "Raw data provided by scooter service"
    loader: "https://t.me/inzhenerka_dbt_bot"
    tables:
      - name: "trips"
        description: "Scooter trips"
        freshness: 
          error_after:
            count: 730
            period: day
          warn_after:
            count: 1
            period: day
        loaded_at_field: "finished_at at time zone 'UTC'"
        
      - name: "users"
        description: "Users of scooter service"
        columns:
          - name: "sex"
            description: "User gender"
            tests:
              - accepted_values:
                  values:
                    - "M"
                    - "F"
              - not_null:
                  config:
                    severity: "warn"
                                    
      - name: "events"
        description: "User events"

models:
  - name: "trips_prep"
    description: "Updated scooter trips info"
    config:
      materialized: view
  - name: "trips_stat"
    description: "Overall trips statistics"
  - name: "trips_stat_daily"
    description: "Daily trips statistics"
    config:
      indexes:
        - columns: ['date']
  - name: "trips_age_daily"
    description: "Data prepered for daily statistics by age groups"
  - name: "trips_age_daily_stat"
    description: "Daily trips and revenue statistics by age groups"
  - name: "trips_geom"
    description: "Trips starting and ending points"
    config:
      materialized: view
  - name: "parking_start_stat"
    description: "500 meters precision hexagons for starting points"
  - name: "parking_finish_stat"
    description: "10 meters precision hexagons for finishing points"
  - name: "trips_users"
    description: "Trips data with users info"
    config:
      materialized: incremental
      post-hook: 
        - "analyze dbt.trips_users"
        - sql: "vacuum dbt.trips_users"
          transaction: false
  - name: "events_clean"
    description: "Distinct user events"
    config:
      materialized: incremental
      strategy: merge
      unique_key: ["user_id", "timestamp", "type_id"]
  - name: "trip_concurrency"
    description: "Concurrent trips"
    config:
      materialized: incremental
  - name: "compamies"
    description: "Aggregated info about scooters"
  - name: "companies_trips"
    description: "Statistic by manufacture companies"
  - name: "events_full"
    description: "Distinct user events with meaningful types"
    config:
      materialized: view
  - name: "events_stat"
    description: "Cancel requests statistics"
  - name: "trips_age_group"
    description: "Statistics by user groups"
  - name: "users_full"
    description: "Users with no missing values in sex field"
    



